<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trading Chakra — Indicators + Presets</title>

<!-- Lightweight Charts -->
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
:root{
  --bg:#0b1220; --panel:#0f2233; --muted:#94a3b8; --accent:#38bdf8;
  --up:#22c55e; --down:#ef4444; --surface:#0f1724; --btn:#22b8ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;font-family:Inter,Arial,Helvetica,sans-serif}
#app{display:grid;grid-template-columns:340px 1fr;gap:0;height:100vh}
.sidebar{padding:16px;background:#071222;border-right:1px solid rgba(255,255,255,0.03);overflow:auto}
.sidebar h2{margin:0 0 12px;color:var(--accent);font-size:28px}
.section{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-bottom:12px}
.section h3{margin:0 0 8px;font-size:14px;color:#cfe6f6}

/* watchlist */
#search{width:100%;padding:8px;border-radius:8px;border:none;background:#06111a;color:#cfe8ff;margin-bottom:10px}
#watchlist{list-style:none;padding:0;margin:0 0 12px 0;height:220px;overflow:auto}
#watchlist li{background:#122635;margin:8px 0;padding:12px;border-radius:8px;cursor:pointer;color:#e6eef8;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center}
#watchlist li.active{background:#254a63}
#add-row{display:flex;gap:8px;margin-top:6px}
#add-stock{flex:1;padding:8px;border-radius:8px;border:none;background:#041221;color:#e6eef8}
#add-btn{background:var(--btn);border:none;padding:8px 12px;border-radius:8px;color:#042233;cursor:pointer}

/* presets UI */
#presets-list{list-style:none;padding:0;margin:0;max-height:200px;overflow:auto}
.preset-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px;background:#081828}
.preset-item button{background:transparent;border:none;color:#cfe6f6;cursor:pointer;padding:6px}

/* inputs */
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="text"], input[type="number"], input[type="range"], select{width:100%;padding:8px;border-radius:6px;border:none;background:#041221;color:#e6eef8;margin-bottom:8px}
.small{width:70px;display:inline-block;margin-right:6px}

/* top bar / controls */
.topbar{height:56px;display:flex;align-items:center;padding:0 18px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(0,0,0,0.2), rgba(0,0,0,0.03))}
#symbol-title{font-weight:700;margin-right:20px}
#timeframes{display:flex;gap:8px;align-items:center}
.tf-btn{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:8px 12px;border-radius:8px;color:#cfe8ff;cursor:pointer}
.tf-btn.active{background:var(--btn);color:#042233;}

/* indicator toggles */
.controls{margin-left:auto;display:flex;gap:12px;align-items:center}
.ctrl-item{display:flex;gap:6px;align-items:center;color:#cfe6f6}
.ctrl-item input{margin-right:6px}

/* chart area */
.chart-area{display:flex;flex-direction:column;height:100vh;background:var(--surface)}
#chart-wrapper{position:relative;flex:1;display:flex;min-height:0}
#chart{flex:1;min-height:0}
#volume{height:110px;border-top:1px solid rgba(255,255,255,0.03)}

/* spinner & messages */
#spinner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.7);padding:12px 18px;border-radius:10px;font-weight:700}
.hidden{display:none}
#error{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#2b0f0f;color:#ffd2d2;padding:12px 16px;border-radius:8px;max-width:60%;text-align:center;display:none}

/* live price */
#live-price{position:absolute;right:12px;top:70px;background:rgba(0,0,0,0.6);padding:8px 10px;border-radius:8px;font-weight:700;display:none}

/* responsive */
@media (max-width:1000px){
  #app{grid-template-columns:1fr}
  .sidebar{height:260px;overflow:auto}
  .chart-area{height:calc(100vh - 260px)}
}
</style>
</head>
<body>
<div id="app">
  <aside class="sidebar">
    <h2>Watchlist</h2>

    <div class="section">
      <label>Search</label>
      <input id="search" placeholder="Search symbol..." />
      <ul id="watchlist"></ul>

      <div id="add-row">
        <input id="add-stock" placeholder="Add symbol, e.g. RELIANCE.NS" />
        <button id="add-btn">Add</button>
      </div>
    </div>

    <div class="section">
      <h3>Presets</h3>
      <label>Preset name</label>
      <input id="preset-name" placeholder="Give preset a name" />
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="save-preset" style="flex:1;background:var(--btn);border:none;padding:8px;border-radius:6px;cursor:pointer">Save Preset</button>
        <button id="export-preset" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:6px;cursor:pointer">Export</button>
      </div>
      <div style="margin-bottom:8px;color:var(--muted);font-size:13px">Saved presets:</div>
      <ul id="presets-list"></ul>
    </div>

    <div class="section">
      <h3>Indicator Controls</h3>
      <label><input type="checkbox" id="toggle-reliable" checked> Reliable S/R</label>
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label>Pivot Left</label>
          <input id="pivot-left" type="number" min="1" value="15" />
        </div>
        <div style="width:110px">
          <label>Pivot Right</label>
          <input id="pivot-right" type="number" min="1" value="15" />
        </div>
      </div>

      <hr style="border:none;height:8px">

      <label><input type="checkbox" id="toggle-lux" checked> LuxAlgo S/R</label>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <div style="width:48%">
          <label>Lux len1</label><input id="lux-len1" type="number" min="1" value="50"/>
        </div>
        <div style="width:48%">
          <label>Lux mlt1</label><input id="lux-mlt1" type="number" step="0.1" value="2"/>
        </div>
        <div style="width:48%">
          <label>Lux len2</label><input id="lux-len2" type="number" min="1" value="100"/>
        </div>
        <div style="width:48%">
          <label>Lux mlt2</label><input id="lux-mlt2" type="number" step="0.1" value="2"/>
        </div>
        <div style="width:48%">
          <label>Lux len3</label><input id="lux-len3" type="number" min="1" value="20"/>
        </div>
        <div style="width:48%">
          <label>Lux mlt3</label><input id="lux-mlt3" type="number" step="0.1" value="2"/>
        </div>
      </div>

      <hr style="border:none;height:8px">

      <label><input type="checkbox" id="toggle-island" checked> Island Reversal</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="width:48%">
          <label><input type="checkbox" id="island-trend" checked> Trend Filter</label>
        </div>
        <div style="width:48%">
          <label><input type="checkbox" id="island-volume" checked> Volume Filter</label>
        </div>
        <div style="width:48%">
          <label>R² Threshold</label>
          <input id="island-r2" type="number" step="0.01" value="0.50" min="0" max="1"/>
        </div>
        <div style="width:48%">
          <label>Volatility Mult</label>
          <input id="island-vol" type="number" step="0.1" value="5.0"/>
        </div>
        <div style="width:48%">
          <label><input type="checkbox" id="island-showr2"> Show R² Label</label>
        </div>
      </div>
    </div>

    <div style="color:var(--muted);font-size:13px;margin-top:6px">
      Notes:<br>
      - Presets include indicator toggles & parameters but <b>do not change timeframe</b>.<br>
      - Exported preset is a JSON string you can copy & import later.
    </div>
  </aside>

  <main class="chart-area">
    <div class="topbar">
      <div id="symbol-title">Loading...</div>
      <div id="timeframes">
        <button class="tf-btn" data-tf="1m">1m</button>
        <button class="tf-btn" data-tf="5m">5m</button>
        <button class="tf-btn" data-tf="15m">15m</button>
        <button class="tf-btn" data-tf="30m">30m</button>
        <button class="tf-btn" data-tf="60m">60m</button>
        <button class="tf-btn active" data-tf="1D">1D</button>
        <button class="tf-btn" data-tf="1W">1W</button>
        <button class="tf-btn" data-tf="1M">1M</button>
      </div>

      <div class="controls">
        <div class="ctrl-item"><input id="ctrl-reliable" type="checkbox" checked> Reliable</div>
        <div class="ctrl-item"><input id="ctrl-lux" type="checkbox" checked> Lux</div>
        <div class="ctrl-item"><input id="ctrl-island" type="checkbox" checked> Island</div>
      </div>
    </div>

    <div id="chart-wrapper">
      <div id="chart"></div>
      <div id="spinner">Loading...</div>
      <div id="error"></div>
      <div id="live-price"></div>
    </div>

    <div id="volume"></div>
  </main>
</div>

<script>
/* -----------------------------
   CONFIG / STATE
   ----------------------------- */
const WORKER_URL = "https://black-tree-2e32.sriviadithi.workers.dev/?symbol=";
const POLL_INTERVAL = 15000; // ms
const PRESETS_KEY = 'tc_indicator_presets_v1';
const WATCHLIST_KEY = 'tc_watchlist_v1';

/* HTML refs */
const watchlistEl = document.getElementById('watchlist');
const addStockInput = document.getElementById('add-stock');
const addBtn = document.getElementById('add-btn');
const spinner = document.getElementById('spinner');
const errorBox = document.getElementById('error');
const symbolTitle = document.getElementById('symbol-title');
const livePrice = document.getElementById('live-price');
const tfButtons = document.querySelectorAll('.tf-btn');

const toggleReliable = document.getElementById('toggle-reliable');
const pivotLeftInput = document.getElementById('pivot-left');
const pivotRightInput = document.getElementById('pivot-right');

const toggleLux = document.getElementById('toggle-lux');
const luxLen1 = document.getElementById('lux-len1');
const luxMlt1 = document.getElementById('lux-mlt1');
const luxLen2 = document.getElementById('lux-len2');
const luxMlt2 = document.getElementById('lux-mlt2');
const luxLen3 = document.getElementById('lux-len3');
const luxMlt3 = document.getElementById('lux-mlt3');

const toggleIsland = document.getElementById('toggle-island');
const islandTrend = document.getElementById('island-trend');
const islandVolume = document.getElementById('island-volume');
const islandR2 = document.getElementById('island-r2');
const islandVol = document.getElementById('island-vol');
const islandShowR2 = document.getElementById('island-showr2');

const savePresetBtn = document.getElementById('save-preset');
const presetNameInput = document.getElementById('preset-name');
const presetsListEl = document.getElementById('presets-list');
const exportBtn = document.getElementById('export-preset');

/* Chart elements */
const chartDiv = document.getElementById('chart');
const volumeDiv = document.getElementById('volume');

/* global chart objects */
let chart = null, candleSeries = null, volumeSeries = null;
let priceLine = null;

/* other state */
let WATCHLIST = [];
let ACTIVE_SYMBOL = null;
let ACTIVE_TF = '1D';
let POLL_TIMER = null;

/* DRAW storage */
const DRAW = { reliable: [], lux: [], island: [] };

/* -----------------------------
   Utility: watchlist persistence
   ----------------------------- */
function loadWatchlist(){
  try{
    const raw = localStorage.getItem(WATCHLIST_KEY);
    WATCHLIST = raw ? JSON.parse(raw) : [
      {symbol:'RELIANCE.NS', label:'RELIANCE'},
      {symbol:'TCS.NS', label:'TCS'},
      {symbol:'INFY.NS', label:'INFY'},
      {symbol:'HDFCBANK.NS', label:'HDFCBANK'},
      {symbol:'ICICIBANK.NS', label:'ICICIBANK'}
    ];
  }catch(e){ WATCHLIST = []; }
}
function saveWatchlist(){ localStorage.setItem(WATCHLIST_KEY, JSON.stringify(WATCHLIST)); }

/* render watchlist */
function renderWatchlist(){
  watchlistEl.innerHTML = '';
  WATCHLIST.forEach(item=>{
    const li = document.createElement('li');
    li.dataset.symbol = item.symbol;
    li.textContent = item.label || item.symbol;
    li.addEventListener('click', ()=> loadChart(item.symbol));
    if(ACTIVE_SYMBOL === item.symbol) li.classList.add('active');
    watchlistEl.appendChild(li);
  });
}

/* add symbol */
addBtn.addEventListener('click', ()=>{
  const v = addStockInput.value.trim();
  if(!v) return;
  let sym = v.toUpperCase();
  if(!sym.includes('.')) sym = sym + '.NS';
  WATCHLIST.unshift({symbol:sym, label: sym.replace('.NS','')});
  saveWatchlist(); renderWatchlist();
  addStockInput.value = '';
  loadChart(sym);
});

/* search filter */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  [...watchlistEl.children].forEach(li=>{
    li.style.display = (!q || li.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
});

/* timeframe buttons */
tfButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tfButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    ACTIVE_TF = btn.dataset.tf;
    if(ACTIVE_SYMBOL) loadChart(ACTIVE_SYMBOL);
  });
});

/* -----------------------------
   Chart creation
   ----------------------------- */
function createChart(){
  if(chart) return;
  chart = LightweightCharts.createChart(chartDiv, {
    layout:{backgroundColor:'#0e1624',textColor:'#d1d4dc'},
    grid:{vertLines:{color:'#253248'},horzLines:{color:'#253248'}},
    rightPriceScale:{borderColor:'#485c7b'},
    timeScale:{borderColor:'#485c7b'},
    localization:{dateFormat:'yyyy-MM-dd'}
  });
  candleSeries = chart.addCandlestickSeries({ upColor:'#22c55e', downColor:'#ef4444', borderVisible:true, wickVisible:true });
  volumeSeries = chart.addHistogramSeries({ priceFormat:{type:'volume'}, priceScaleId:'', scaleMargins:{top:0.8,bottom:0} });
  window.addEventListener('resize', ()=> chart.applyOptions({ width: chartDiv.clientWidth, height: chartDiv.clientHeight }));
}

/* -----------------------------
   Worker fetch helper
   Worker must return array of {time, open, high, low, close, volume?}
   For tf=last the worker may return single object or array with one element.
   ----------------------------- */
async function fetchData(symbol, tf){
  const url = WORKER_URL + encodeURIComponent(symbol) + '&tf=' + encodeURIComponent(tf);
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP ' + res.status);
  const j = await res.json();
  // normalize to array
  const arr = Array.isArray(j) ? j : (j ? [j] : []);
  // normalize times -> unix seconds
  return arr.map(d=>{
    let t = d.time;
    if(typeof t === 'string'){ const dt = Date.parse(t); if(!isNaN(dt)) t = Math.floor(dt/1000); }
    if(typeof t === 'number' && String(t).length > 10) t = Math.floor(t/1000); // ms -> s
    return { time: t, open:+d.open, high:+d.high, low:+d.low, close:+d.close, volume:+(d.volume||0) };
  });
}

/* -----------------------------
   Indicator calculations (JS versions)
   Each uses current UI parameters
   ----------------------------- */

/* Reliable S/R pivot-based */
function calcReliableSR(ohlc, opts){
  // opts: {left,right, lookback}
  const left = opts.left || 15, right = opts.right || 15;
  const res = {res:[], sup:[]};
  if(!ohlc || ohlc.length < left + right + 3) return res;
  const n = ohlc.length;
  for(let i=left;i<n-right;i++){
    const hi = ohlc[i].high, lo = ohlc[i].low;
    let isPh = true, isPl = true;
    for(let l=1;l<=left;l++){
      if(ohlc[i-l].high >= hi) isPh = false;
      if(ohlc[i-l].low <= lo) isPl = false;
    }
    for(let r=1;r<=right;r++){
      if(ohlc[i+r].high >= hi) isPh = false;
      if(ohlc[i+r].low <= lo) isPl = false;
    }
    if(isPh) res.res.push({price:hi, idx:i});
    if(isPl) res.sup.push({price:lo, idx:i});
  }
  res.res.sort((a,b)=>b.idx-a.idx);
  res.sup.sort((a,b)=>b.idx-a.idx);
  function pickUnique(arr,count=3){
    const out=[]; for(const it of arr){
      const exists = out.some(x=>Math.abs(x-it.price) < (it.price*0.0005 + 0.0001));
      if(!exists) out.push(it.price);
      if(out.length>=count) break;
    }
    return out;
  }
  return {res: pickUnique(res.res,3), sup: pickUnique(res.sup,3)};
}

/* Lux-like S/R: SMA ± mlt * sd */
function calcLuxSR(ohlc, choices){
  if(!ohlc || ohlc.length < 5) return [];
  const closes = ohlc.map(x=>x.close);
  function sma(arr,len){
    if(arr.length < len) return null;
    let s=0; for(let i=arr.length-len;i<arr.length;i++) s+=arr[i];
    return s/len;
  }
  const out=[];
  for(const ch of choices){
    const len = ch.len, mlt = ch.mlt;
    if(closes.length < len) continue;
    const mean = sma(closes,len);
    const slice = closes.slice(-len);
    const sd = Math.sqrt(slice.reduce((acc,v)=>acc+(v-mean)*(v-mean),0)/slice.length);
    out.push({price: mean + mlt*sd, name:'lux_up_'+len});
    out.push({price: mean - mlt*sd, name:'lux_lo_'+len});
  }
  return out;
}

/* Island Reversals: simple gap detection */
function calcIslandReversals(ohlc){
  const boxes=[];
  if(!ohlc || ohlc.length<3) return boxes;
  // scan last N bars for gaps
  for(let i=1;i<ohlc.length;i++){
    const prev = ohlc[i-1], cur = ohlc[i];
    if(cur.low > prev.high){ // bullish gap (island start)
      let end=i, limit=i+40;
      while(end+1<ohlc.length && ohlc[end+1].low > prev.high && end<limit) end++;
      const highs = ohlc.slice(i,end+1).map(x=>x.high), lows=ohlc.slice(i,end+1).map(x=>x.low);
      boxes.push({start:i, end:end, top:Math.max(...highs), bottom:Math.min(...lows), bullish:true});
    } else if(cur.high < prev.low){ // bearish gap
      let end=i, limit=i+40;
      while(end+1<ohlc.length && ohlc[end+1].high < prev.low && end<limit) end++;
      const highs = ohlc.slice(i,end+1).map(x=>x.high), lows=ohlc.slice(i,end+1).map(x=>x.low);
      boxes.push({start:i, end:end, top:Math.max(...highs), bottom:Math.min(...lows), bullish:false});
    }
  }
  return boxes;
}

/* -----------------------------
   Drawing helpers using createPriceLine
   ----------------------------- */
function clearDrawings(){
  if(!candleSeries) return;
  DRAW.reliable.forEach(l=>{ try{ candleSeries.removePriceLine(l) }catch(e){} });
  DRAW.lux.forEach(l=>{ try{ candleSeries.removePriceLine(l) }catch(e){} });
  DRAW.island.forEach(o=>{
    try{ candleSeries.removePriceLine(o.topLine); candleSeries.removePriceLine(o.botLine); }catch(e){}
  });
  DRAW.reliable = []; DRAW.lux = []; DRAW.island = [];
}

function drawReliable(levels){
  if(!toggleReliable.checked) return;
  const colorR = '#ff6666', colorS = '#66ffb3';
  if(!candleSeries) return;
  levels.res.forEach(p=>{
    const line = candleSeries.createPriceLine({ price: p, color: colorR, lineWidth:2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible:true, title: 'R' });
    DRAW.reliable.push(line);
  });
  levels.sup.forEach(p=>{
    const line = candleSeries.createPriceLine({ price: p, color: colorS, lineWidth:2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible:true, title: 'S' });
    DRAW.reliable.push(line);
  });
}

function drawLux(entries){
  if(!toggleLux.checked) return;
  if(!candleSeries) return;
  entries.forEach((e,i)=>{
    const color = i%2===0 ? '#ffd54d' : '#8bd3ff';
    const line = candleSeries.createPriceLine({ price: e.price, color: color, lineWidth:1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible:false });
    DRAW.lux.push(line);
  });
}

function drawIslands(boxes){
  if(!toggleIsland.checked) return;
  if(!candleSeries) return;
  boxes.forEach(b=>{
    const color = b.bullish ? '#66ffb3' : '#ff8b8b';
    const topLine = candleSeries.createPriceLine({ price: b.top, color: color, lineWidth:1, lineStyle: LightweightCharts.LineStyle.Dotted, axisLabelVisible:false });
    const botLine = candleSeries.createPriceLine({ price: b.bottom, color: color, lineWidth:1, lineStyle: LightweightCharts.LineStyle.Dotted, axisLabelVisible:false });
    DRAW.island.push({ topLine, botLine, meta: b });
  });
}

/* live price marker */
function setLivePrice(price){
  if(!candleSeries) return;
  if(priceLine){ try{ candleSeries.removePriceLine(priceLine); }catch(e){}; priceLine = null; }
  priceLine = candleSeries.createPriceLine({ price: price, color:'#22c55e', lineWidth:2, axisLabelVisible:true, title: price.toFixed(2) });
  livePrice.style.display = ''; livePrice.textContent = price.toFixed(2);
}

/* -----------------------------
   loadChart main
   ----------------------------- */
async function loadChart(symbol){
  ACTIVE_SYMBOL = symbol;
  symbolTitle.textContent = symbol;
  [...watchlistEl.children].forEach(li=> li.classList.toggle('active', li.dataset.symbol === symbol));

  createChart();
  spinner.classList.remove('hidden');
  errorBox.style.display = 'none';
  clearDrawings();

  try{
    const raw = await fetchData(symbol, ACTIVE_TF);
    if(!raw || raw.length === 0) throw new Error('No data');

    // set series
    candleSeries.setData(raw.map(d=>({time:d.time, open:d.open, high:d.high, low:d.low, close:d.close})));
    volumeSeries.setData(raw.map(d=>({time:d.time, value:d.volume||0, color: d.close>=d.open? '#22c55e' : '#ef4444'})));
    chart.timeScale().fitContent();

    // compute using UI params
    const reliableOpts = { left: parseInt(pivotLeftInput.value||15), right: parseInt(pivotRightInput.value||15) };
    const reliable = calcReliableSR(raw, reliableOpts);
    drawReliable(reliable);

    const luxChoices = [
      {len: parseInt(luxLen1.value||50), mlt: parseFloat(luxMlt1.value||2)},
      {len: parseInt(luxLen2.value||100), mlt: parseFloat(luxMlt2.value||2)},
      {len: parseInt(luxLen3.value||20), mlt: parseFloat(luxMlt3.value||2)}
    ];
    const lux = calcLuxSR(raw, luxChoices);
    drawLux(lux);

    // island: use last N bars for local detection
    const islands = calcIslandReversals(raw.slice(-400));
    drawIslands(islands);

    const last = raw[raw.length-1];
    setLivePrice(last.close);

    spinner.classList.add('hidden');

    // polling
    if(POLL_TIMER) clearInterval(POLL_TIMER);
    POLL_TIMER = setInterval(()=> pollLivePrice(symbol), POLL_INTERVAL);

  }catch(err){
    spinner.classList.add('hidden');
    errorBox.style.display = 'block';
    errorBox.textContent = 'Failed to load chart: ' + (err.message || err);
    console.error(err);
  }
}

/* poll small latest tick (worker should support tf=last) */
async function pollLivePrice(symbol){
  try{
    const url = WORKER_URL + encodeURIComponent(symbol) + '&tf=last';
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    const obj = Array.isArray(j) ? j[j.length-1] : j;
    if(obj && obj.close !== undefined) setLivePrice(+obj.close);
  }catch(e){
    console.debug('poll err', e);
  }
}

/* -----------------------------
   Presets: save / load / delete / apply
   ----------------------------- */
function loadPresets(){
  try{
    const raw = localStorage.getItem(PRESETS_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function savePresets(list){
  localStorage.setItem(PRESETS_KEY, JSON.stringify(list));
}

/* build current settings object */
function currentSettings(){
  return {
    name: (document.getElementById('preset-name').value || '').trim(),
    toggles: {
      reliable: !!toggleReliable.checked,
      lux: !!toggleLux.checked,
      island: !!toggleIsland.checked
    },
    reliable: {
      left: parseInt(pivotLeftInput.value||15),
      right: parseInt(pivotRightInput.value||15)
    },
    lux: {
      len1: parseInt(luxLen1.value||50), mlt1: parseFloat(luxMlt1.value||2),
      len2: parseInt(luxLen2.value||100), mlt2: parseFloat(luxMlt2.value||2),
      len3: parseInt(luxLen3.value||20), mlt3: parseFloat(luxMlt3.value||2)
    },
    island: {
      trend: !!islandTrend.checked,
      volume: !!islandVolume.checked,
      r2: parseFloat(islandR2.value||0.5),
      volMult: parseFloat(islandVol.value||5.0),
      showR2: !!islandShowR2.checked
    },
    // note: we DO NOT store timeframe per your choice
    meta: { created: Date.now() }
  };
}

/* apply settings object to UI */
function applySettingsToUI(settings){
  if(!settings) return;
  toggleReliable.checked = !!settings.toggles?.reliable;
  toggleLux.checked = !!settings.toggles?.lux;
  toggleIsland.checked = !!settings.toggles?.island;

  pivotLeftInput.value = settings.reliable?.left ?? pivotLeftInput.value;
  pivotRightInput.value = settings.reliable?.right ?? pivotRightInput.value;

  luxLen1.value = settings.lux?.len1 ?? luxLen1.value;
  luxMlt1.value = settings.lux?.mlt1 ?? luxMlt1.value;
  luxLen2.value = settings.lux?.len2 ?? luxLen2.value;
  luxMlt2.value = settings.lux?.mlt2 ?? luxMlt2.value;
  luxLen3.value = settings.lux?.len3 ?? luxLen3.value;
  luxMlt3.value = settings.lux?.mlt3 ?? luxMlt3.value;

  islandTrend.checked = !!settings.island?.trend;
  islandVolume.checked = !!settings.island?.volume;
  islandR2.value = settings.island?.r2 ?? islandR2.value;
  islandVol.value = settings.island?.volMult ?? islandVol.value;
  islandShowR2.checked = !!settings.island?.showR2;

  // re-draw chart with new settings (but keep same timeframe)
  if(ACTIVE_SYMBOL) {
    clearDrawings();
    loadChart(ACTIVE_SYMBOL);
  }
}

/* render presets UI */
function renderPresetsUI(){
  const list = loadPresets();
  presetsListEl.innerHTML = '';
  list.forEach((p, idx)=>{
    const li = document.createElement('li');
    li.className='preset-item';
    const left = document.createElement('div');
    left.style.flex='1';
    left.innerHTML = `<div style="font-weight:700">${p.name || 'Preset ' + (idx+1)}</div><div style="font-size:12px;color:var(--muted)">${new Date(p.meta?.created||Date.now()).toLocaleString()}</div>`;
    const right = document.createElement('div');
    const applyBtn = document.createElement('button'); applyBtn.textContent='Apply';
    const delBtn = document.createElement('button'); delBtn.textContent='Delete';
    const exportBtn = document.createElement('button'); exportBtn.textContent='JSON';
    applyBtn.addEventListener('click', ()=> applyPreset(idx));
    delBtn.addEventListener('click', ()=> deletePreset(idx));
    exportBtn.addEventListener('click', ()=> exportPreset(idx));
    right.appendChild(exportBtn); right.appendChild(applyBtn); right.appendChild(delBtn);
    li.appendChild(left); li.appendChild(right);
    presetsListEl.appendChild(li);
  });
}

/* save preset button */
savePresetBtn.addEventListener('click', ()=>{
  const name = (presetNameInput.value || '').trim();
  if(!name){ alert('Give preset a name'); return; }
  const current = currentSettings();
  current.name = name;
  const list = loadPresets();
  list.unshift(current);
  savePresets(list);
  renderPresetsUI();
  presetNameInput.value = '';
});

/* apply preset by index */
function applyPreset(index){
  const list = loadPresets();
  if(!list[index]) return;
  applySettingsToUI(list[index]);
}

/* delete */
function deletePreset(index){
  const list = loadPresets();
  if(!list[index]) return;
  if(!confirm('Delete preset "' + (list[index].name||'') + '"?')) return;
  list.splice(index,1);
  savePresets(list);
  renderPresetsUI();
}

/* export preset as JSON (single) */
function exportPreset(index){
  const list = loadPresets();
  const p = list[index];
  if(!p) return;
  const json = JSON.stringify(p, null, 2);
  // show in prompt for easy copy
  prompt('Preset JSON (copy & save):', json);
}

/* import via export button (allows pasting JSON) */
exportBtn.addEventListener('click', ()=>{
  const curr = currentSettings();
  const json = prompt('Paste preset JSON to import (or Cancel):');
  if(!json) return;
  try{
    const obj = JSON.parse(json);
    const list = loadPresets();
    list.unshift(obj);
    savePresets(list);
    renderPresetsUI();
    alert('Imported preset: ' + (obj.name||'unnamed'));
  }catch(e){ alert('Invalid JSON'); }
});

/* load presets at startup */
renderPresetsUI();

/* -----------------------------
   toggles in topbar mirror main toggles (so both control same)
   ----------------------------- */
document.getElementById('ctrl-reliable').addEventListener('change', (e) => { toggleReliable.checked = e.target.checked; if(ACTIVE_SYMBOL) loadChart(ACTIVE_SYMBOL); });
document.getElementById('ctrl-lux').addEventListener('change', (e) => { toggleLux.checked = e.target.checked; if(ACTIVE_SYMBOL) loadChart(ACTIVE_SYMBOL); });
document.getElementById('ctrl-island').addEventListener('change', (e) => { toggleIsland.checked = e.target.checked; if(ACTIVE_SYMBOL) loadChart(ACTIVE_SYMBOL); });

/* when any settings inputs change, re-draw */
[
  toggleReliable, pivotLeftInput, pivotRightInput,
  toggleLux, luxLen1, luxMlt1, luxLen2, luxMlt2, luxLen3, luxMlt3,
  toggleIsland, islandTrend, islandVolume, islandR2, islandVol, islandShowR2
].forEach(el => el.addEventListener('change', ()=> { if(ACTIVE_SYMBOL) { clearDrawings(); loadChart(ACTIVE_SYMBOL); } }));

/* -----------------------------
   init / load defaults
   ----------------------------- */
function init(){
  loadWatchlist();
  renderWatchlist();
  // set first symbol
  if(WATCHLIST.length) loadChart(WATCHLIST[0].symbol);
  // preload presets UI
  renderPresetsUI();
}
init();

/* cleanup */
window.addEventListener('beforeunload', ()=> { if(POLL_TIMER) clearInterval(POLL_TIMER); });

</script>
</body>
</html>
