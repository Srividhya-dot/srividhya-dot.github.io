<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro Charting Dashboard</title>

<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
:root{
  --bg:#071122;
  --panel:#0b2230;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --up:#22c55e;
  --down:#ef4444;
  --surface:#0f1724;
}

/* RESET + BASE */
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
html,body{margin:0;height:100%;background:var(--bg);color:#e6eef8;overflow:hidden}

.app{display:flex;height:100vh;width:100vw;overflow:hidden}

/* LEFT WATCHLIST */
.side{
  width:280px;min-width:280px;
  background:#081a28;padding:18px;
  border-right:1px solid rgba(255,255,255,0.04);
  overflow-y:auto;
}
.side h2{margin:0 0 14px;color:var(--accent);font-size:26px}

.search{
  width:100%;padding:10px 12px;margin-bottom:12px;
  border-radius:8px;border:none;background:#0d2535;color:#cfe6ff;
}

.watchlist{list-style:none;padding:0;margin:0}
.watchlist li{
  padding:14px;margin:8px 0;border-radius:8px;
  background:#102a39;color:#e6eef8;
  cursor:pointer;font-weight:600;letter-spacing:0.5px
}
.watchlist li.active{background:#1b4356}

.add-row{display:flex;gap:8px;margin-top:12px}
.add-row input{
  flex:1;padding:10px;border:none;border-radius:8px;
  background:#0d2535;color:#cfe6ff;
}
.add-row button{
  background:var(--accent);color:#021c28;
  padding:10px 14px;border:none;border-radius:8px;cursor:pointer;
}

/* RIBBON INDICATOR BAR (TOP) */
.ribbon{
  width:100%;
  background:#0b2030;
  padding:12px;
  display:flex;gap:20px;align-items:center;
  border-bottom:1px solid rgba(255,255,255,0.05);
}
.ribbon-section{
  display:flex;align-items:center;gap:6px;
  background:#102634;padding:8px 12px;border-radius:8px;
}
.ribbon label{font-size:13px;color:var(--muted)}
.ribbon input,.ribbon select{
  padding:6px 8px;border:none;border-radius:6px;
  background:#0d2535;color:#cfe6ff;
}
.ribbon .chk{width:16px;height:16px}

/* MAIN AREA */
.main{
  flex:1;display:flex;flex-direction:column;
  min-width:0;overflow:hidden;
}

/* TOOLBAR */
.toolbar{
  height:60px;display:flex;align-items:center;
  gap:16px;padding:0 16px;
  background:#071826;
  border-bottom:1px solid rgba(255,255,255,0.04);
}
.title{font-size:20px;font-weight:700}

.tf-group{display:flex;gap:8px}
.tf-btn{
  padding:8px 12px;border:none;border-radius:8px;
  background:#0e283a;color:#cfe6ff;cursor:pointer;
}
.tf-btn.active{
  background:var(--accent);color:#021c28;
}

/* CHART */
.chart-wrap{
  flex:1;display:flex;position:relative;min-height:0;
}
.chart-box{
  flex:1;padding:0;background:var(--surface);
  display:flex;flex-direction:column;min-height:0;
}
#chart{flex:1;min-height:0}

/* SPINNER + ERROR */
.spinner, .error{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  padding:12px 18px;border-radius:8px;
  font-weight:700;z-index:20
}
.spinner{background:rgba(0,0,0,0.6)}
.error{background:#4a1010;color:#ffd2d2;display:none}

.hidden{display:none}

@media(max-width:900px){
  .side{display:none}
}
</style>
</head>

<body>

<div class="app">
  <!-- LEFT PANEL -->
  <aside class="side">
    <h2>Watchlist</h2>

    <input id="searchInput" class="search" placeholder="Search symbol..." />

    <ul id="watchlist" class="watchlist"></ul>

    <div class="add-row">
      <input id="addSymbol" placeholder="Add symbol (e.g., TCS.NS)">
      <button id="addBtn">Add</button>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <main class="main">

    <!-- RIBBON PANEL (TOP INDICATOR CONTROLS) -->
    <div class="ribbon">

      <div class="ribbon-section">
        <label>Reliable S/R</label>
        <input type="checkbox" id="toggleReliable" class="chk" checked>
        <label>L</label>
        <input id="pivotLeft" type="number" value="15" min="1" style="width:60px">
        <label>R</label>
        <input id="pivotRight" type="number" value="15" min="1" style="width:60px">
      </div>

      <div class="ribbon-section">
        <label>LuxAlgo</label>
        <input type="checkbox" id="toggleLux" class="chk" checked>
        <label>Len</label>
        <input id="luxLen1" type="number" value="50" min="2" style="width:60px">
        <label>Mlt</label>
        <input id="luxMlt1" type="number" value="2" min="0.1" step="0.1" style="width:60px">
      </div>

      <div class="ribbon-section">
        <label>Island</label>
        <input type="checkbox" id="toggleIsland" class="chk" checked>
        <label>Trend</label>
        <input id="islandTrend" type="number" value="10" min="2" style="width:60px">
        <label>Vol</label>
        <input type="checkbox" id="islandVolFilter" checked class="chk">
      </div>

      <div class="ribbon-section">
        <label>Volume</label>
        <input type="checkbox" id="showVolume" checked class="chk">
      </div>

      <div class="ribbon-section">
        <label>Live (sec)</label>
        <input id="pollInterval" type="number" value="5" min="2" style="width:70px">
      </div>

      <button id="applyIndicators" style="padding:8px 16px;border:none;border-radius:8px;background:var(--accent);color:#021c28;cursor:pointer">
        Apply
      </button>

    </div>

    <!-- TOOLBAR: SYMBOL + TIMEFRAMES -->
    <div class="toolbar">
      <div class="title" id="symbolTitle">Loading...</div>

      <div class="tf-group" id="timeframes">
        <button class="tf-btn" data-tf="1m">1m</button>
        <button class="tf-btn" data-tf="5m">5m</button>
        <button class="tf-btn" data-tf="15m">15m</button>
        <button class="tf-btn" data-tf="30m">30m</button>
        <button class="tf-btn" data-tf="60m">60m</button>
        <button class="tf-btn active" data-tf="1D">1D</button>
        <button class="tf-btn" data-tf="1W">1W</button>
        <button class="tf-btn" data-tf="1M">1M</button>
      </div>
    </div>

    <div class="chart-wrap">
      <div class="chart-box">
        <div id="chart"></div>
        <div id="spinner" class="spinner hidden">Loading...</div>
        <div id="error" class="error"></div>
      </div>
    </div>

  </main>
</div>

<script>
/* ---------------------------------------------
   CONFIG
---------------------------------------------- */
const WORKER_URL_YAHOO = "https://black-tree-2e32.sriviadithi.workers.dev/?symbol=";
const ALPHA_KEY = "C99VSVXV4LQO45SE";  // Your AlphaVantage API Key
let DATA_SOURCE = "yahoo"; // default (option B selected)

const DEFAULT_SYMBOLS = ["RELIANCE.NS","TCS.NS","INFY.NS","HDFCBANK.NS","ICICIBANK.NS"];

/* DOM REFS */
const watchlistEl = document.getElementById('watchlist');
const symbolTitle = document.getElementById('symbolTitle');
const chartDiv = document.getElementById('chart');
const spinner = document.getElementById('spinner');
const errorBox = document.getElementById('error');

const addSymbolInput = document.getElementById('addSymbol');
const addBtn = document.getElementById('addBtn');
const searchInput = document.getElementById('searchInput');

const tfButtons = Array.from(document.querySelectorAll('.tf-btn'));

const toggleReliable = document.getElementById('toggleReliable');
const toggleLux = document.getElementById('toggleLux');
const toggleIsland = document.getElementById('toggleIsland');
const showVolume = document.getElementById('showVolume');

const pivotLeft = document.getElementById('pivotLeft');
const pivotRight = document.getElementById('pivotRight');

const luxLen1 = document.getElementById('luxLen1');
const luxMlt1 = document.getElementById('luxMlt1');

const islandTrend = document.getElementById('islandTrend');
const islandVolFilter = document.getElementById('islandVolFilter');

const pollIntervalInput = document.getElementById('pollInterval');
const applyIndicatorsBtn = document.getElementById('applyIndicators');

/* STATE */
let watchSymbols = JSON.parse(localStorage.getItem('watchSymbols')) || DEFAULT_SYMBOLS.slice();
let chart = null;
let candleSeries = null;
let volumeSeries = null;
let srLines = [];
let lastSymbol = null;
let activeTF = "1D";


/* ---------------------------------------------
   CHART INIT
---------------------------------------------- */
function createChart(){
  if(chart) return;

  chart = LightweightCharts.createChart(chartDiv, {
    layout:{ backgroundColor:"#0f1724", textColor:"#d1d4dc"},
    rightPriceScale:{ borderColor:"#485c7b" },
    timeScale:{ borderColor:"#485c7b", timeVisible:true, secondsVisible:false },
    grid:{ vertLines:{color:"#253248"}, horzLines:{color:"#253248"} }
  });

  candleSeries = chart.addCandlestickSeries({
    upColor:"#22c55e",
    downColor:"#ef4444",
    borderVisible:true,
    wickVisible:true
  });

  volumeSeries = chart.addHistogramSeries({
    priceFormat:{ type:'volume' },
    priceScaleId:'',
    scaleMargins:{ top:0.8, bottom:0 }
  });
}
/* ---------------------------------------------
   FETCH — YAHOO FINANCE (default)
---------------------------------------------- */
async function fetchYahoo(symbol, range='1y', gran='1d') {
  const url = WORKER_URL_YAHOO + encodeURIComponent(symbol) + `&range=${range}&interval=${gran}`;
  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(res.status);

    const json = await res.json();

    // Worker returns simple array
    if (Array.isArray(json))
      return json.map(normalizeBar);

    // Yahoo JSON structure
    if (json?.chart?.result?.[0]) {
      const r = json.chart.result[0];
      const timestamps = r.timestamp;
      const q = r.indicators?.quote?.[0];

      if (Array.isArray(timestamps) && q) {
        const out = [];
        for (let i = 0; i < timestamps.length; i++) {
          const o = q.open?.[i];
          const h = q.high?.[i];
          const l = q.low?.[i];
          const c = q.close?.[i];
          const v = q.volume?.[i] ?? 0;
          if (o == null || h == null || l == null || c == null) continue;

          out.push({
            time: timestamps[i],
            open: o,
            high: h,
            low: l,
            close: c,
            volume: v
          });
        }
        return out.map(normalizeBar);
      }
    }

    return [];

  } catch (err) {
    console.error("Yahoo fetch error", err);
    return [];
  }
}

/* ---------------------------------------------
   FETCH — ALPHA VANTAGE (Intraday + Daily)
---------------------------------------------- */
async function fetchAlpha(symbol, interval="1min") {
  const url =
    `https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${symbol}` +
    `&interval=${interval}&apikey=${ALPHA_KEY}&outputsize=full`;

  try {
    const res = await fetch(url, { cache: "no-store" });
    const json = await res.json();

    const key = Object.keys(json).find(k => k.includes("Time Series"));
    if (!key) return [];

    const series = json[key];
    const out = [];

    for (const t in series) {
      const row = series[t];
      const ts = Math.floor(new Date(t).getTime() / 1000);
      out.push({
        time: ts,
        open: +row["1. open"],
        high: +row["2. high"],
        low: +row["3. low"],
        close: +row["4. close"],
        volume: +row["5. volume"]
      });
    }

    return out.sort((a, b) => a.time - b.time);

  } catch (err) {
    console.error("Alpha fetch error", err);
    return [];
  }
}

/* ---------------------------------------------
   UNIVERSAL FETCH WRAPPER
---------------------------------------------- */
async function fetchOHLC(symbol, range='1y', gran='1d'){

  if (DATA_SOURCE === "alpha") {
    // Convert granularity
    let intv = "1min";
    if (gran === "5m") intv = "5min";
    if (gran === "15m") intv = "15min";
    if (gran === "30m") intv = "30min";
    if (gran === "60m") intv = "60min";

    return fetchAlpha(symbol, intv);
  }

  // Fallback to Yahoo
  return fetchYahoo(symbol, range, gran);
}

/* ---------------------------------------------
   NORMALIZATION
---------------------------------------------- */
function normalizeBar(b) {
  let t = b.time;
  if (t > 1e12) t = Math.floor(t / 1000); // ms → sec
  return {
    time: t,
    open: +b.open,
    high: +b.high,
    low: +b.low,
    close: +b.close,
    volume: +(b.volume || 0),
  };
}

/* ---------------------------------------------
   TIMEFRAME CONVERSION
---------------------------------------------- */
const tfSeconds = {
  "1m": 60,
  "5m": 300,
  "15m": 900,
  "30m": 1800,
  "60m": 3600,
  "1D": 86400,
  "1W": 86400 * 7,
  "1M": 86400 * 30
};

function convertToTF(bars, srcSec, tf) {
  const target = tfSeconds[tf] || 86400;

  // If matching — no conversion
  if (srcSec === target) return bars.slice();

  // If going to higher TF (aggregate)
  if (target > srcSec) {
    const groups = new Map();
    for (const b of bars) {
      const k = Math.floor(b.time / target);
      if (!groups.has(k)) groups.set(k, []);
      groups.get(k).push(b);
    }

    const out = [];
    groups.forEach(arr => {
      const o = arr[0].open;
      const c = arr[arr.length - 1].close;
      const h = Math.max(...arr.map(x => x.high));
      const l = Math.min(...arr.map(x => x.low));
      const v = arr.reduce((s, x) => s + x.volume, 0);

      out.push({
        time: arr[0].time,
        open: o, high: h, low: l, close: c, volume: v
      });
    });

    return out;
  }

  // If lower TF but only daily data → synthesize (approx)
  const out = [];
  const parts = Math.floor(86400 / target);

  for (const d of bars) {
    const step = (d.close - d.open) / parts;

    for (let i = 0; i < parts; i++) {
      const o = d.open + step * i;
      const c = d.open + step * (i + 1);

      out.push({
        time: d.time + i * target,
        open: o,
        high: Math.max(o, c, d.high),
        low: Math.min(o, c, d.low),
        close: c,
        volume: Math.floor(d.volume / parts)
      });
    }
  }

  return out;
}

/* ---------------------------------------------
   INDICATOR — RELIABLE SUPPORT / RESISTANCE
---------------------------------------------- */
function computeReliableSR(bars, L=15, R=15){
  const out = [];

  for (let i = L; i < bars.length - R; i++) {
    // pivot high
    let isPH = true;
    for (let j = i - L; j <= i + R; j++) {
      if (bars[i].high < bars[j].high) { isPH = false; break; }
    }

    // pivot low
    let isPL = true;
    for (let j = i - L; j <= i + R; j++) {
      if (bars[i].low > bars[j].low) { isPL = false; break; }
    }

    if (isPH) out.push({ price: bars[i].high, color:"#ef4444", width:2 });
    if (isPL) out.push({ price: bars[i].low, color:"#22c55e", width:2 });
  }

  // Clean duplicates
  const merged = [];
  for (const lv of out) {
    const f = merged.find(m => Math.abs(m.price - lv.price) < lv.price * 0.002);
    if (!f) merged.push(lv);
  }

  return merged;
}

/* ---------------------------------------------
   INDICATOR — SIMPLE LUX SR (SMA + bands)
---------------------------------------------- */
function computeLuxSR(bars, len=50, mlt=2) {
  if (bars.length < len) return [];

  const closes = bars.map(b => b.close);
  const levels = [];

  let sum = 0;
  for (let i = 0; i < closes.length; i++) {
    sum += closes[i];
    if (i >= len) sum -= closes[i - len];

    if (i >= len - 1) {
      const sma = sum / len;
      const win = closes.slice(i - len + 1, i + 1);
      const mean = sma;
      const std = Math.sqrt(win.reduce((s, x) => s + (x - mean) ** 2, 0) / len);

      levels.push({
        sma,
        upper: sma + mlt * std,
        lower: sma - mlt * std
      });
    }
  }

  const last = levels[levels.length - 1];
  return [
    { price: last.upper, color:"#ffd166", width:1 },
    { price: last.sma, color:"#60a5fa", width:2 },
    { price: last.lower, color:"#7c3aed", width:1 }
  ];
}

/* ---------------------------------------------
   INDICATOR — ISLAND REVERSALS (simple)
---------------------------------------------- */
function computeIslandReversals(bars, trendLen=10, volFilter=true){
  const out = [];

  for (let i = 1; i < bars.length - 1; i++) {
    const prev = bars[i - 1];
    const cur = bars[i];
    const next = bars[i + 1];

    // bullish island
    if (cur.low > prev.high && next.high < cur.low) {
      if (volFilter) {
        let avg = 0;
        for (let j = Math.max(0, i - trendLen); j < i; j++)
          avg += bars[j].volume;
        avg = avg / Math.min(i, trendLen);
        if (cur.volume < avg) continue;
      }
      out.push({ top: cur.high, bottom: cur.low, bullish: true });
    }

    // bearish island
    if (cur.high < prev.low && next.low > cur.high) {
      if (volFilter) {
        let avg = 0;
        for (let j = Math.max(0, i - trendLen); j < i; j++)
          avg += bars[j].volume;
        avg = avg / Math.min(i, trendLen);
        if (cur.volume < avg) continue;
      }
      out.push({ top: cur.high, bottom: cur.low, bullish: false });
    }
  }

  return out;
}
/* -------------------------------------------------
   CLEAR OLD INDICATORS
-------------------------------------------------- */
let currentLines = [];

function clearIndicators() {
  for (const line of currentLines) {
    try { candleSeries.removePriceLine(line); } catch(e){}
  }
  currentLines = [];
}

/* -------------------------------------------------
   DRAW HORIZONTAL S/R LEVELS
-------------------------------------------------- */
function drawSR(levels) {
  for (const L of levels) {
    const pl = candleSeries.createPriceLine({
      price: L.price,
      color: L.color,
      lineWidth: L.width,
      axisLabelVisible: true
    });
    currentLines.push(pl);
  }
}

/* -------------------------------------------------
   DRAW ISLAND REVERSALS (TOP & BOTTOM LINES)
-------------------------------------------------- */
function drawIslands(islands){
  for (const I of islands) {
    const col = I.bullish ? "rgba(8,153,129,0.25)" : "rgba(242,54,69,0.25)";
    const top = candleSeries.createPriceLine({
      price: I.top,
      color: col,
      lineWidth: 2,
      axisLabelVisible: true
    });
    const bottom = candleSeries.createPriceLine({
      price: I.bottom,
      color: col,
      lineWidth: 2,
      axisLabelVisible: true
    });
    currentLines.push(top, bottom);
  }
}

/* -------------------------------------------------
   LOAD CHART (MAIN)
-------------------------------------------------- */
async function loadChart(symbol) {
  lastSymbol = symbol;
  attachActiveToList(symbol);
  createChart();
  hideError();
  showSpinner();
  symbolTitle.textContent = symbol;

  /* FETCH RAW */
  const raw = await fetchOHLC(symbol, "1y", "1d");
  hideSpinner();

  if (!raw || raw.length === 0) {
    showError("No data for " + symbol);
    return;
  }

  // sort ascending
  raw.sort((a, b) => a.time - b.time);

  /* DETECT SOURCE PERIOD */
  let srcSec = 86400;
  if (raw.length >= 2) {
    const diff = raw[1].time - raw[0].time;
    if (diff > 1) srcSec = diff;
  }

  /* TIMEFRAME CONVERSION */
  const converted = convertToTF(raw, srcSec, activeTF);

  /* CHART SET DATA */
  candleSeries.setData(
    converted.map(b => ({
      time: b.time,
      open: b.open,
      high: b.high,
      low: b.low,
      close: b.close
    }))
  );

  if (showVolume.checked) {
    volumeSeries.setData(
      converted.map(b => ({
        time: b.time,
        value: b.volume,
        color: b.close >= b.open ? "#22c55e" : "#ef4444"
      }))
    );
  } else {
    volumeSeries.setData([]);
  }

  chart.timeScale().fitContent();

  /* INDICATORS */
  clearIndicators();

  if (toggleReliable.checked) {
    const sr = computeReliableSR(converted, pivotLeft.valueAsNumber, pivotRight.valueAsNumber);
    drawSR(sr);
  }
  if (toggleLux.checked) {
    const lux = computeLuxSR(converted, luxLen1.valueAsNumber, luxMlt1.valueAsNumber);
    drawSR(lux);
  }
  if (toggleIsland.checked) {
    const isl = computeIslandReversals(converted, islandTrend.valueAsNumber, islandVolFilter.checked);
    drawIslands(isl);
  }

  setupLivePolling(symbol);
}

/* -------------------------------------------------
   LIVE POLLING (ONLY DURING MARKET HOURS)
-------------------------------------------------- */
let pollTimer = null;

function isTradingNow() {
  const d = new Date();
  const h = d.getHours();
  const m = d.getMinutes();
  // NSE trading 9:15–15:30 (safe margin)
  if (h < 9 || (h === 9 && m < 15)) return false;
  if (h > 15 || (h === 15 && m > 30)) return false;
  return true;
}

async function fetchLatestDaily(symbol) {
  const data = await fetchOHLC(symbol, "5d", "1d");
  if (!data.length) return null;
  return data[data.length - 1];
}

function setupLivePolling(symbol) {
  if (pollTimer) clearInterval(pollTimer);

  const interval = Math.max(2, pollIntervalInput.valueAsNumber || 5);

  pollTimer = setInterval(async () => {
    if (!isTradingNow()) return;

    const last = await fetchLatestDaily(symbol);
    if (!last) return;

    // Quick update: reload chart (safer)
    loadChart(symbol);

  }, interval * 1000);
}

/* -------------------------------------------------
   APPLY INDICATORS BUTTON
-------------------------------------------------- */
applyIndicatorsBtn.addEventListener("click", () => {
  if (lastSymbol) loadChart(lastSymbol);
});

/* -------------------------------------------------
   INIT: LOAD FIRST SYMBOL
-------------------------------------------------- */
if (watchSymbols.length > 0) {
  loadChart(watchSymbols[0]);
}

</script>
</body>
</html>
