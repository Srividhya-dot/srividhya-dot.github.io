<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chart + Watchlist Dashboard</title>

<!-- Lightweight Charts CDN (correct & stable version) -->
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
:root{
  --bg:#071122; --panel:#0b2230; --muted:#94a3b8; --accent:#38bdf8;
  --up:#22c55e; --down:#ef4444; --surface:#0f1724;
  --card:#0f2a37;
}
*{box-sizing:border-box;font-family:Inter, Arial, sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8}
.app{display:flex;height:100vh;overflow:hidden}

/* Left Panel */
.side{
  width:300px;background:#061827;padding:18px;
  border-right:1px solid rgba(255,255,255,0.08);overflow:auto
}
.side h2{margin:0 0 12px;color:var(--accent);font-size:26px}
.search{width:100%;background:#071826;color:#cfe6ff;padding:10px;margin-bottom:12px;border-radius:8px;border:none}
.watchlist li{
  background:#122b36;margin:10px 0;padding:14px;border-radius:8px;cursor:pointer;
  text-transform:uppercase;font-weight:600
}
.watchlist li.active{background:#244f63}
.add-row{display:flex;gap:8px;margin-top:10px}
.add-row input{flex:1;background:#071026;padding:10px;color:#cfe6ff;border-radius:8px;border:none}
.add-row button{background:var(--accent);color:#01222b;padding:10px 14px;border-radius:8px;border:none}

/* Top controls */
.toolbar{
  height:70px;background:#0b1e2b;border-bottom:1px solid rgba(255,255,255,0.1);
  display:flex;align-items:center;gap:12px;padding:0 20px
}
.toolbar input,.toolbar select{
  background:#091826;border:none;border-radius:6px;color:#d8e4f6;padding:6px 10px;width:55px
}
.tf-btn{
  background:#091d2c;border:none;color:#d8e4f6;padding:8px 12px;
  border-radius:6px;cursor:pointer
}
.tf-btn.active{background:var(--accent);color:#001b26}

/* Chart */
.chart-wrap{flex:1;display:flex;flex-direction:column;min-height:0}
#chart{flex:1;min-height:0}

/* Indicator panel */
.right{
  width:360px;background:#06151e;border-left:1px solid rgba(255,255,255,0.1);
  padding:16px;overflow:auto
}
.right h3{margin:0 0 10px;color:var(--accent)}
.ctrl{margin-bottom:12px}
.ctrl input{width:100%;padding:8px;background:#071827;border:none;border-radius:6px;color:#cfe6ff}

.spinner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#0008;padding:12px 20px;border-radius:10px}
.error{display:none;background:#2b0f0f;color:#ffd2d2;padding:10px;border-radius:8px;text-align:center;margin-top:10px}
</style>
</head>
<body>

<div class="app">

  <!-- LEFT PANEL -->
  <aside class="side">
    <h2>Watchlist</h2>

    <input id="searchInput" class="search" placeholder="Search symbol..."/>
    <ul id="watchlist" class="watchlist"></ul>

    <div class="add-row">
      <input id="addSymbol" placeholder="Add symbol, e.g. RELIANCE.NS"/>
      <button id="addBtn">Add</button>
    </div>

    <h3 style="margin-top:20px">Presets</h3>
    <div class="preset-row">
      <input id="presetName" placeholder="Preset name" style="flex:1;background:#071826;color:#cfe6ff;border:none;padding:8px;border-radius:8px"/>
      <button id="savePreset" style="background:var(--accent);padding:8px 14px;border-radius:8px;border:none;color:#00121a">Save</button>
    </div>

    <button id="exportPresets" style="margin-top:8px;background:#071826;border:1px solid #123;color:#ccc;padding:8px 10px;border-radius:8px;width:100%">Export</button>

    <div id="presetList" style="margin-top:10px;font-size:13px;color:#9bb">Saved presets:</div>
  </aside>

  <!-- MAIN PANEL -->
  <main class="main">
    <div class="toolbar">

      <!-- S/R -->
      <span style="color:#9bb">Reliable S/R</span>
      <input id="pivotLeft" type="number" value="15"/>
      <input id="pivotRight" type="number" value="15"/>
      <input id="toggleReliable" type="checkbox" checked/>

      <!-- Lux -->
      <span style="color:#9bb;margin-left:10px">LuxAlgo</span>
      <input id="luxLen1" type="number" value="50"/>
      <input id="luxMlt1" type="number" value="2"/>
      <input id="toggleLux" type="checkbox" checked/>

      <!-- Island -->
      <span style="color:#9bb;margin-left:10px">Island</span>
      <input id="islandTrend" type="number" value="10"/>
      <input id="toggleIsland" type="checkbox" checked/>

      <!-- Timeframes -->
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="tf-btn" data-tf="1m">1m</button>
        <button class="tf-btn" data-tf="5m">5m</button>
        <button class="tf-btn" data-tf="15m">15m</button>
        <button class="tf-btn" data-tf="30m">30m</button>
        <button class="tf-btn" data-tf="60m">60m</button>
        <button class="tf-btn active" data-tf="1D">1D</button>
        <button class="tf-btn" data-tf="1W">1W</button>
        <button class="tf-btn" data-tf="1M">1M</button>
      </div>

    </div>

    <div class="chart-wrap">
      <div id="chart"></div>
      <div id="spinner" class="spinner" style="display:none">Loading...</div>
      <div id="error" class="error"></div>
    </div>

  </main>
  <!-- RIGHT PANEL -->
  <aside class="right">
    <h3>Indicator Controls</h3>

    <div class="ctrl">
      <label><input type="checkbox" id="showVolume" checked/> Show Volume</label>
    </div>

    <div class="ctrl">
      <label>Reliable S/R: Pivot Left</label>
      <input id="pivotLeft2" type="number" value="15"/>

      <label style="margin-top:8px">Pivot Right</label>
      <input id="pivotRight2" type="number" value="15"/>
    </div>

    <div class="ctrl">
      <label>LuxAlgo Length</label>
      <input id="luxLen2" type="number" value="50"/>

      <label style="margin-top:8px">Multiplier</label>
      <input id="luxMlt2" type="number" value="2"/>
    </div>

    <div class="ctrl">
      <label>Island Trend Length</label>
      <input id="islandTrend2" type="number" value="10"/>
    </div>

    <button id="applyIndicators" style="background:var(--accent);color:#00131b;padding:10px;border:none;border-radius:8px;width:100%;margin-top:10px">Apply</button>

    <div style="margin-top:20px;color:#9bb;font-size:13px">
      Live update interval (seconds)
    </div>
    <input id="pollInterval" type="number" min="2" value="5" style="margin-top:6px"/>

    <div style="margin-top:10px;color:#678;font-size:12px">
      During market hours, prices update automatically.
    </div>
  </aside>

</div><!-- end .app -->

<script>
/* -----------------------------------------------------------
    CONFIG
------------------------------------------------------------ */
const ALPHA_KEY = "C99VSVXV4LQO45SE";
const DEFAULT_SYMBOLS = ["RELIANCE.NS","TCS.NS","INFY.NS","HDFCBANK.NS","ICICIBANK.NS"];

let watchSymbols = JSON.parse(localStorage.getItem("watchSymbols") || "[]");
if(watchSymbols.length === 0) watchSymbols = DEFAULT_SYMBOLS.slice();

let presets = JSON.parse(localStorage.getItem("chartPresets") || "{}");

let chart = null;
let candleSeries = null;
let volumeSeries = null;
let srLines = [];
let lastSymbol = null;
let activeTF = "1D";

/* IMPORTANT â€” only declare pollTimer ONCE */
let pollTimer = null;


/* -----------------------------------------------------------
    DOM REFS
------------------------------------------------------------ */
const chartDiv = document.getElementById("chart");
const spinner = document.getElementById("spinner");
const errorBox = document.getElementById("error");

const watchlistEl = document.getElementById("watchlist");
const addSymbolInput = document.getElementById("addSymbol");
const addBtn = document.getElementById("addBtn");
const searchInput = document.getElementById("searchInput");

const showVolume = document.getElementById("showVolume");

const pivotLeft = document.getElementById("pivotLeft");
const pivotRight = document.getElementById("pivotRight");
const luxLen1 = document.getElementById("luxLen1");
const luxMlt1 = document.getElementById("luxMlt1");
const islandTrend = document.getElementById("islandTrend");
const toggleReliable = document.getElementById("toggleReliable");
const toggleLux = document.getElementById("toggleLux");
const toggleIsland = document.getElementById("toggleIsland");

const presetName = document.getElementById("presetName");
const savePresetBtn = document.getElementById("savePreset");
const presetList = document.getElementById("presetList");
const exportPresetsBtn = document.getElementById("exportPresets");

const applyIndicatorsBtn = document.getElementById("applyIndicators");
const pollIntervalInput = document.getElementById("pollInterval");

const tfButtons = Array.from(document.querySelectorAll(".tf-btn"));

/* -----------------------------------------------------------
    UTILITIES
------------------------------------------------------------ */
function showSpinner(){ spinner.style.display = "block"; }
function hideSpinner(){ spinner.style.display = "none"; }
function showError(msg){ errorBox.style.display="block"; errorBox.textContent = msg; }
function hideError(){ errorBox.style.display="none"; }
/* -----------------------------------------------------------
    WATCHLIST RENDERING
------------------------------------------------------------ */
function renderWatchlist(){
  watchlistEl.innerHTML = "";
  watchSymbols.forEach(sym=>{
    const li = document.createElement("li");
    li.textContent = sym;
    li.dataset.symbol = sym;
    li.addEventListener("click", ()=> loadChart(sym));
    watchlistEl.appendChild(li);
  });
  highlightActive(lastSymbol);
}

function highlightActive(symbol){
  Array.from(watchlistEl.children).forEach(li=>{
    li.classList.toggle("active", li.dataset.symbol === symbol);
  });
}

addBtn.addEventListener("click", ()=>{
  const v = (addSymbolInput.value || "").trim().toUpperCase();
  if(!v) return;
  if(!watchSymbols.includes(v)){
    watchSymbols.unshift(v);
    localStorage.setItem("watchSymbols", JSON.stringify(watchSymbols));
    renderWatchlist();
  }
  addSymbolInput.value = "";
  loadChart(v);
});

searchInput.addEventListener("input", e=>{
  const q = e.target.value.toLowerCase();
  Array.from(watchlistEl.children).forEach(li=>{
    li.style.display = li.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});


/* -----------------------------------------------------------
    TIMEFRAME SWITCH
------------------------------------------------------------ */
tfButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    tfButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    activeTF = btn.dataset.tf;
    if(lastSymbol) loadChart(lastSymbol);
  });
});


/* -----------------------------------------------------------
    PRESETS
------------------------------------------------------------ */
function renderPresets(){
  presetList.innerHTML = "Saved presets:";
  const keys = Object.keys(presets);
  if(keys.length === 0){
    presetList.innerHTML += `<div style="color:#789;margin-top:8px">None saved</div>`;
    return;
  }
  keys.forEach(name=>{
    const row = document.createElement("div");
    row.style.marginTop = "6px";
    row.innerHTML = `
      <strong>${name}</strong>
      <button class="loadPreset" data-name="${name}">Load</button>
      <button class="delPreset" data-name="${name}">Delete</button>
    `;
    presetList.appendChild(row);
  });

  document.querySelectorAll(".loadPreset").forEach(b=>{
    b.addEventListener("click", ()=>{
      const p = presets[b.dataset.name];
      applyPreset(p);
    });
  });

  document.querySelectorAll(".delPreset").forEach(b=>{
    b.addEventListener("click", ()=>{
      delete presets[b.dataset.name];
      localStorage.setItem("chartPresets", JSON.stringify(presets));
      renderPresets();
    });
  });
}

savePresetBtn.addEventListener("click", ()=>{
  const name = (presetName.value || "").trim();
  if(!name){ alert("Enter name"); return; }

  presets[name] = {
    left: pivotLeft.valueAsNumber,
    right: pivotRight.valueAsNumber,
    len: luxLen1.valueAsNumber,
    mlt: luxMlt1.valueAsNumber,
    island: islandTrend.valueAsNumber,
    reliable: toggleReliable.checked,
    lux: toggleLux.checked,
    isl: toggleIsland.checked
  };
  localStorage.setItem("chartPresets", JSON.stringify(presets));
  renderPresets();
  presetName.value = "";
});

exportPresetsBtn.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(presets,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "presets.json";
  a.click();
  URL.revokeObjectURL(url);
});

function applyPreset(p){
  pivotLeft.value = p.left;
  pivotRight.value = p.right;
  luxLen1.value = p.len;
  luxMlt1.value = p.mlt;
  islandTrend.value = p.island;

  toggleReliable.checked = p.reliable;
  toggleLux.checked = p.lux;
  toggleIsland.checked = p.isl;

  if(lastSymbol) loadChart(lastSymbol);
}


/* -----------------------------------------------------------
    ALPHA VANTAGE + YAHOO API FETCHER (AUTO-FALLBACK)
------------------------------------------------------------ */
async function fetchOHLC(symbol, tf="1D"){
  const isDaily = tf === "1D" || tf === "1W" || tf === "1M";
  const alphaFn = isDaily ? "TIME_SERIES_DAILY_ADJUSTED" : "TIME_SERIES_INTRADAY";

  let interval = "15min";
  if(tf === "5m") interval = "5min";
  if(tf === "1m") interval = "1min";
  if(tf === "30m") interval = "30min";
  if(tf === "60m") interval = "60min";

  /* -------------------------------------
        TRY ALPHA VANTAGE FIRST
  -------------------------------------- */
  try{
    const url = isDaily
      ? `https://www.alphavantage.co/query?function=${alphaFn}&symbol=${symbol}&apikey=${ALPHA_KEY}`
      : `https://www.alphavantage.co/query?function=${alphaFn}&symbol=${symbol}&interval=${interval}&apikey=${ALPHA_KEY}`;

    const res = await fetch(url);
    const json = await res.json();

    let key = isDaily ? "Time Series (Daily)" : `Time Series (${interval})`;

    if(json[key]){
      return Object.entries(json[key]).map(([date, ohlc])=>({
        time: Math.floor(new Date(date).getTime()/1000),
        open: +ohlc["1. open"],
        high: +ohlc["2. high"],
        low: +ohlc["3. low"],
        close: +ohlc["4. close"],
        volume: +ohlc["6. volume"] || +ohlc["5. volume"] || 0
      })).reverse();
    }
  }catch(e){
    console.warn("Alpha error",e);
  }

  /* -------------------------------------
        FALLBACK: YAHOO FINANCE
  -------------------------------------- */
  try{
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=1y`;
    const res = await fetch(url);
    const j = await res.json();

    const r = j.chart.result[0];
    const t = r.timestamp;
    const q = r.indicators.quote[0];

    return t.map((ts,i)=>({
      time: ts,
      open: q.open[i],
      high: q.high[i],
      low: q.low[i],
      close: q.close[i],
      volume: q.volume[i] || 0
    }));
  }catch(e){
    console.warn("Yahoo fallback error",e);
  }

  return [];
}
/* -----------------------------------------------------------
    INDICATOR LOGIC
------------------------------------------------------------ */

/* ---------- Reliable S/R ---------- */
function computeReliableSR(bars, L=15, R=15){
  const levels = [];
  for(let i=L; i<bars.length-R; i++){
    let ph = true, pl = true;
    for(let j=i-L; j<=i+R; j++){
      if(bars[j].high > bars[i].high) ph = false;
      if(bars[j].low < bars[i].low) pl = false;
    }
    if(ph) levels.push({price: bars[i].high, color:"#f55"});
    if(pl) levels.push({price: bars[i].low, color:"#5f5"});
  }
  return levels;
}

/* ---------- LuxAlgo Simplified ---------- */
function computeLuxSR(bars,len=50,mlt=2){
  if(bars.length < len) return [];
  let out = [];
  for(let i=len;i<bars.length;i++){
    const slice = bars.slice(i-len,i);
    const avg = slice.reduce((a,b)=>a+b.close,0)/len;
    const variance = slice.reduce((s,b)=> s + (b.close-avg)**2,0)/len;
    const stdev = Math.sqrt(variance);
    out = [
      {price: avg + stdev*mlt, color:"#ffcc00"},
      {price: avg,             color:"#66aaff"},
      {price: avg - stdev*mlt, color:"#aa55ff"}
    ];
  }
  return out;
}

/* ---------- Island Reversals ---------- */
function computeIsland(bars,trend=10){
  const islands = [];
  for(let i=2;i<bars.length-2;i++){
    const p = bars[i-1];
    const c = bars[i];
    const n = bars[i+1];

    // Bullish island
    if(c.low > p.high && n.high < c.low){
      islands.push({top:c.high, bottom:c.low, color:"rgba(0,255,128,0.12)"});
    }

    // Bearish island
    if(c.high < p.low && n.low > c.high){
      islands.push({top:c.high, bottom:c.low, color:"rgba(255,80,80,0.12)"});
    }
  }
  return islands;
}

/* -----------------------------------------------------------
    CHART CLEAR & DRAW
------------------------------------------------------------ */
function clearIndicators(){
  srLines.forEach(line=>{
    try{ candleSeries.removePriceLine(line); }catch(_) {}
  });
  srLines = [];
}

function drawHorizontal(levels){
  levels.forEach(L=>{
    const pl = candleSeries.createPriceLine({
      price: L.price,
      color: L.color,
      lineWidth: 2,
      axisLabelVisible: true
    });
    srLines.push(pl);
  });
}

function drawIslands(arr){
  arr.forEach(i=>{
    const top = candleSeries.createPriceLine({price:i.top,color:i.color});
    const bottom = candleSeries.createPriceLine({price:i.bottom,color:i.color});
    srLines.push(top,bottom);
  });
}


/* -----------------------------------------------------------
    MAIN: LOAD CHART
------------------------------------------------------------ */
  function attachActiveToList(sym){
  Array.from(watchlistEl.children).forEach(li=>{
    li.classList.toggle('active', li.dataset.symbol === sym);
  });
}

async function loadChart(symbol){
  lastSymbol = symbol;
  highlightActive(symbol);
  symbolTitle.textContent = symbol;
  clearIndicators();
  showLoading();

  createChart();

  const bars = await fetchOHLC(symbol, activeTF);
  hideLoading();

  if(!bars.length){
    showError("No data returned");
    return;
  }

  candleSeries.setData(bars.map(b=>({
    time:b.time,
    open:b.open,
    high:b.high,
    low:b.low,
    close:b.close
  })));

  /* ---- Volume ---- */
  if(showVolume.checked){
    volumeSeries.setData(bars.map(b=>({
      time:b.time,
      value:b.volume,
      color: b.close >= b.open ? "#4caf50" : "#ff5252"
    })));
  }else{
    volumeSeries.setData([]);
  }

  /* ---- Indicators ---- */
  clearIndicators();

  if(toggleReliable.checked){
    drawHorizontal(
      computeReliableSR(bars, pivotLeft.valueAsNumber, pivotRight.valueAsNumber)
    );
  }
  if(toggleLux.checked){
    drawHorizontal(
      computeLuxSR(bars, luxLen1.valueAsNumber, luxMlt1.valueAsNumber)
    );
  }
  if(toggleIsland.checked){
    drawIslands(computeIsland(bars, islandTrend.valueAsNumber));
  }

  chart.timeScale().fitContent();
}


/* -----------------------------------------------------------
    STARTUP
------------------------------------------------------------ */
renderWatchlist();
renderPresets();
loadChart(watchSymbols[0] || "RELIANCE.NS");


/* -----------------------------------------------------------
    END
------------------------------------------------------------ */
</script>
</body>
</html>
